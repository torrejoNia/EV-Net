count(weighted_networks[["lr_sig"]][["from"]])
length(weighted_networks[["lr_sig"]][["from"]])
knitr::opts_chunk$set(
collapse = TRUE,
# comment = "#>",
warning = FALSE,
message = FALSE
)
weighted_networks <- readRDS(url("https://zenodo.org/records/7074291/files/weighted_networks_nsga2r_final_mouse.rds"))
#ligand_tf_matrix <- readRDS(url("https://zenodo.org/records/7074291/files/ligand_tf_matrix_nsga2r_final_mouse.rds"))
lr_network <- readRDS(url("https://zenodo.org/records/7074291/files/lr_network_mouse_21122021.rds"))
sig_network <- readRDS(url("https://zenodo.org/records/7074291/files/signaling_network_mouse_21122021.rds"))
gr_network <- readRDS(url("https://zenodo.org/records/7074291/files/gr_network_mouse_21122021.rds"))
length(weighted_networks[["lr_sig"]][["from"]])
unique(length(weighted_networks[["lr_sig"]][["from"]]))
length(unique(weighted_networks[["lr_sig"]][["from"]]))
length(unique(weighted_networks[["lr_sig"]][["to"]]))
unique(intersect(weighted_networks[["lr_sig"]][["from"]], weighted_networks[["lr_sig"]][["to"]]))
length(unique(intersect(weighted_networks[["lr_sig"]][["from"]], weighted_networks[["lr_sig"]][["to"]])))
knitr::opts_chunk$set(
collapse = TRUE,
# comment = "#>",
warning = FALSE,
message = FALSE
)
weighted_networks <- readRDS(url("https://zenodo.org/records/7074291/files/weighted_networks_nsga2r_final_mouse.rds"))
#ligand_tf_matrix <- readRDS(url("https://zenodo.org/records/7074291/files/ligand_tf_matrix_nsga2r_final_mouse.rds"))
lr_network <- readRDS(url("https://zenodo.org/records/7074291/files/lr_network_mouse_21122021.rds"))
sig_network <- readRDS(url("https://zenodo.org/records/7074291/files/signaling_network_mouse_21122021.rds"))
gr_network <- readRDS(url("https://zenodo.org/records/7074291/files/gr_network_mouse_21122021.rds"))
knitr::opts_chunk$set(
collapse = TRUE,
# comment = "#>",
warning = FALSE,
message = FALSE
)
gr_network <- readRDS(url("https://zenodo.org/records/7074291/files/gr_network_mouse_21122021.rds"))
View(gr_network)
lr_network <- readRDS(url("https://zenodo.org/records/7074291/files/lr_network_mouse_21122021.rds"))
View(lr_network)
r_files <- list.files("../R", pattern = "\\.R$", full.names = TRUE)
lapply(r_files, source)
knitr::opts_chunk$set(echo = TRUE, fig.path='figures/', message=FALSE)
library(Seurat)
library(SeuratObject)
library(tidyverse)
library(dplyr)
library(here)
library(nichenetr)
LPS_microglia_EVs <- read.csv("~/embo/Usecase2/mmc4.csv", stringsAsFactors = FALSE)
LPS_microglia_EVs <- LPS_microglia_EVs %>%
separate_rows(X, sep = ";")
write.csv(LPS_microglia_EVs, "~/embo/Usecase2/LPS_microglia_EVs.csv", row.names = FALSE)
EV_cargo <- LPS_microglia_EVs %>%
filter(diff.LPS.Control > 0, Pr..F. < 0.1) %>%
pull(X)
View(LPS_microglia_EVs)
LPS_microglia_EVs_RNAseq <- read.csv("~/embo/Usecase2/mmc10.csv", stringsAsFactors = FALSE)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 1) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 2) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 4) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 10) %>%
pull(X)
receiving_microglia_expression <- read.csv("~/embo/Usecase2/mmc16.csv", stringsAsFactors = FALSE)
receiving_microglia_expression <- receiving_microglia_expression %>%
separate(X, into = c("UniProt", "Ensembl"), sep = "\\|", extra = "drop", fill = "right")
geneset_oi <- receiving_microglia_expression %>%
filter(padj < 0.1) %>%
pull(UniProt)
#abs(log2FoldChange) >= 0.25
expressed_genes_receiver <- receiving_microglia_expression$UniProt
organism <- "mouse"
if(organism == "human"){
lr_network <- readRDS(url("https://zenodo.org/record/7074291/files/lr_network_human_21122021.rds"))
weighted_networks <- readRDS(url("https://zenodo.org/record/7074291/files/weighted_networks_nsga2r_final.rds"))
} else if(organism == "mouse"){
lr_network <- readRDS(url("https://zenodo.org/record/7074291/files/lr_network_mouse_21122021.rds"))
weighted_networks <- readRDS(url("https://zenodo.org/record/7074291/files/weighted_networks_nsga2r_final_mouse.rds"))
}
lr_network <- lr_network %>% distinct(from, to)
head(lr_network)
EV_cargo_target_matrix <- readRDS("~/embo/Netiev/EV_cargo_target_matrix.rds")
#Replace file path with the path in which you stored the EV_cargo_target_matrix rds file
gc()
all_genes <- unique(rownames(EV_cargo_target_matrix))
expressed_interactors <- intersect(all_genes, expressed_genes_receiver)
lr_sig <- weighted_networks[["lr_sig"]]
gr <- weighted_networks[["gr"]]
potential_EV_cargo_prot <- lr_sig[lr_sig$to %in% expressed_interactors, "from"]
potential_EV_cargo_tf <- gr[gr$to %in% expressed_interactors, "from"]
potential_EV_cargo <- unique(c(potential_EV_cargo_prot$from, potential_EV_cargo_tf$from))
EV_cargo <- intersect(potential_EV_cargo, EV_cargo)
EV_cargo_target_matrix <- EV_cargo_target_matrix[rownames(EV_cargo_target_matrix) %in% expressed_genes_receiver, colnames(EV_cargo_target_matrix) %in% EV_cargo]
gc()
geneset_oi <- geneset_oi %>% .[. %in% rownames(EV_cargo_target_matrix)]
background_expressed_genes <- expressed_genes_receiver %>% .[. %in% rownames(EV_cargo_target_matrix)]
EV_cargo_activities <- predict_ligand_activities(geneset = geneset_oi,
background_expressed_genes = background_expressed_genes,
ligand_target_matrix = EV_cargo_target_matrix,
potential_ligands = EV_cargo)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 20) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 15) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 10) %>%
pull(X)
EV_cargo <- LPS_microglia_EVs_RNAseq %>%
filter(pvalue < 0.05, log2FoldChange > 11) %>%
pull(X)
EV_cargo_target_matrix <- readRDS("~/embo/Netiev/EV_cargo_target_matrix.rds")
#Replace file path with the path in which you stored the EV_cargo_target_matrix rds file
all_genes <- unique(rownames(EV_cargo_target_matrix))
expressed_interactors <- intersect(all_genes, expressed_genes_receiver)
lr_sig <- weighted_networks[["lr_sig"]]
gr <- weighted_networks[["gr"]]
potential_EV_cargo_prot <- lr_sig[lr_sig$to %in% expressed_interactors, "from"]
potential_EV_cargo_tf <- gr[gr$to %in% expressed_interactors, "from"]
potential_EV_cargo <- unique(c(potential_EV_cargo_prot$from, potential_EV_cargo_tf$from))
EV_cargo <- intersect(potential_EV_cargo, EV_cargo)
geneset_oi <- geneset_oi %>% .[. %in% rownames(EV_cargo_target_matrix)]
EV_cargo_target_matrix <- EV_cargo_target_matrix[rownames(EV_cargo_target_matrix) %in% expressed_genes_receiver, colnames(EV_cargo_target_matrix) %in% EV_cargo]
gc()
background_expressed_genes <- expressed_genes_receiver %>% .[. %in% rownames(EV_cargo_target_matrix)]
EV_cargo_activities <- predict_ligand_activities(geneset = geneset_oi,
background_expressed_genes = background_expressed_genes,
ligand_target_matrix = EV_cargo_target_matrix,
potential_ligands = EV_cargo)
EV_cargo_target_matrix <- readRDS("~/embo/Netiev/EV_cargo_target_matrix.rds")
#Replace file path with the path in which you stored the EV_cargo_target_matrix rds file
EV_cargo_activities <- predict_ligand_activities(geneset = geneset_oi,
background_expressed_genes = background_expressed_genes,
ligand_target_matrix = EV_cargo_target_matrix,
potential_ligands = EV_cargo)
gc()
LPS_microglia_EVs <- read.csv("~/embo/Usecase2/mmc4.csv", stringsAsFactors = FALSE)
LPS_microglia_EVs <- LPS_microglia_EVs %>%
separate_rows(X, sep = ";")
EV_cargo <- LPS_microglia_EVs %>%
filter(diff.LPS.Control > 0, Pr..F. < 0.1) %>%
pull(X)
receiving_microglia_expression <- read.csv("~/embo/Usecase2/mmc16.csv", stringsAsFactors = FALSE)
receiving_microglia_expression <- receiving_microglia_expression %>%
separate(X, into = c("UniProt", "Ensembl"), sep = "\\|", extra = "drop", fill = "right")
receiving_microglia_expression <- read.csv("~/embo/Usecase2/mmc16.csv", stringsAsFactors = FALSE)
receiving_microglia_expression <- receiving_microglia_expression %>%
separate(X, into = c("UniProt", "Ensembl"), sep = "\\|", extra = "drop", fill = "right")
geneset_oi <- receiving_microglia_expression %>%
filter(padj < 0.1) %>%
pull(UniProt)
#abs(log2FoldChange) >= 0.25
expressed_genes_receiver <- receiving_microglia_expression$UniProt
all_genes <- unique(rownames(EV_cargo_target_matrix))
expressed_interactors <- intersect(all_genes, expressed_genes_receiver)
lr_sig <- weighted_networks[["lr_sig"]]
gr <- weighted_networks[["gr"]]
potential_EV_cargo_prot <- lr_sig[lr_sig$to %in% expressed_interactors, "from"]
potential_EV_cargo_tf <- gr[gr$to %in% expressed_interactors, "from"]
potential_EV_cargo <- unique(c(potential_EV_cargo_prot$from, potential_EV_cargo_tf$from))
EV_cargo <- intersect(potential_EV_cargo, EV_cargo)
geneset_oi <- geneset_oi %>% .[. %in% rownames(EV_cargo_target_matrix)]
EV_cargo_target_matrix <- EV_cargo_target_matrix[rownames(EV_cargo_target_matrix) %in% expressed_genes_receiver, colnames(EV_cargo_target_matrix) %in% EV_cargo]
gc()
background_expressed_genes <- expressed_genes_receiver %>% .[. %in% rownames(EV_cargo_target_matrix)]
EV_cargo_activities <- predict_ligand_activities(geneset = geneset_oi,
background_expressed_genes = background_expressed_genes,
ligand_target_matrix = EV_cargo_target_matrix,
potential_ligands = EV_cargo)
EV_cargo_activities <- EV_cargo_activities %>% arrange(-aupr_corrected) %>% mutate(rank = rank(desc(aupr_corrected)))
EV_cargo_activities
p_hist_EV_cargo_activity <- ggplot(EV_cargo_activities, aes(x=aupr_corrected)) +
geom_histogram(color="black", fill="darkorange")  +
geom_vline(aes(xintercept=min(EV_cargo_activities %>% top_n(30, aupr_corrected) %>% pull(aupr_corrected))),
color="red", linetype="dashed", size=1) +
labs(x="EV cargo activity (PCC)", y = "# EV cargo") +
theme_classic()
p_hist_EV_cargo_activity
best_upstream_EV_cargo <- EV_cargo_activities %>% top_n(30, aupr_corrected) %>% arrange(-aupr_corrected) %>% pull(test_ligand)
vis_EV_cargo_aupr <- EV_cargo_activities %>% filter(test_ligand %in% best_upstream_EV_cargo) %>%
column_to_rownames("test_ligand") %>% select(aupr_corrected) %>% arrange(aupr_corrected) %>% as.matrix(ncol = 1)
(make_heatmap_ggplot(vis_EV_cargo_aupr,
"Prioritized EV cargo", "EV cargo activity",
legend_title = "AUPR", color = "darkorange") +
theme(axis.text.x.top = element_blank()))
active_EV_cargo_target_links_df <- best_upstream_EV_cargo %>%
lapply(get_weighted_ligand_target_links,
geneset = geneset_oi,
ligand_target_matrix = EV_cargo_target_matrix,
n = 80) %>%
bind_rows() %>% drop_na()
active_EV_cargo_target_links <- prepare_ligand_target_visualization(
ligand_target_df = active_EV_cargo_target_links_df,
ligand_target_matrix = EV_cargo_target_matrix,
cutoff = 0.5)
order_EV_cargo <- intersect(best_upstream_EV_cargo, colnames(active_EV_cargo_target_links)) %>% rev()
order_targets <- active_EV_cargo_target_links_df$target %>% unique() %>% intersect(rownames(active_EV_cargo_target_links))
vis_EV_cargo_target <- t(active_EV_cargo_target_links[order_targets,order_EV_cargo])
target_genes_heatmap <- make_heatmap_ggplot(vis_EV_cargo_target, "Prioritized EV cargo", "Predicted target genes",
color = "purple", legend_title = "Regulatory potential") +
scale_fill_gradient2(low = "whitesmoke",  high = "purple")
target_genes_heatmap
target_genes_heatmap
setwd("~/embo/EV-Net")
gc()
